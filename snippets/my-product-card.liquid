{% comment %}
  Renders an prodcut card

  Accepts:
  - product: {Object} Product object
  - ratio: {String} Image ratio
  - has_quick_add: {Boolean} The quick add modal is show(optional). Default is false.
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - is_swiper: {Boolean} Is swiper. Default: false (optional)
  - quick_add_modal: { String } Modal id (optional)

  Usage:
  {% render 'my-product-card' product: product, ratio: ratio %}
{% endcomment %}

{%- if ratio == nil -%}
    {%- assign ratio = "1 / 1" -%}
{%- endif -%}

{%- if has_quick_add == nil -%}
    {%- assign has_quick_add = false -%} 
{%- endif -%}

{%- if is_swiper == nil -%}
    {%- assign is_swiper = false -%}
{%- endif -%}

{%- if quick_add_modal == nil -%}
    {%- assign quick_add_modal = '' -%}
{%- endif -%}

{%- assign current_variant = product -%}
{%- if product != nil and product.has_only_default_variant == false -%}
    {%- assign current_variant = product.selected_or_first_available_variant -%}
{%- endif -%}

<my-product-card 
    class="product-card__container {% if is_swiper %} swiper-slide {% endif %}" 
    data-product-url="{{ product.url }}"
>
    <responsive-container class="product-card__image 
        {% if section.settings.show_operation == 'hover' %} product-card__image-hover {% endif %}
        "
        style="aspect-ratio: {{ ratio }};"
    >
        {% assign variant_image = current_variant.featured_image | default: product.featured_image %}
        {% assign image_class = 'image ' %}
        {% if product.media[1] != null and show_secondary_image == true %}
            {% assign image_class = image_class | append: 'show-secondary ' %}
        {% endif %}
        {%- if variant_image -%}
            {{ 
                variant_image
                | image_url: width: variant_image.width
                | image_tag:
                    alt: product.title, 
                    class:image_class
            }}

            {%- if product.media[1] != null and show_secondary_image == true-%}
                {{
                    product.media[1]
                    | image_url: width: product.media[1].width
                    | image_tag: 
                        alt: product.media[1].alt,
                        class:image_class
                }}
            {%- endif -%}
        {%- endif -%}

        {%- if current_variant.compare_at_price > current_variant.price and current_variant.compare_at_price > 0 -%}
            {%- assign percent = current_variant.price | times: 100 | divided_by: current_variant.compare_at_price -%}
            {%- assign discount = 100 | minus: percent | append: '%' -%}
        {%- else -%}
            {%- assign discount = 0 | append: '%' -%}
        {%- endif -%}

        <div class="left-top">
            {%- if section.settings.show_badge_text -%}
                <div class="badge color-{{ section.settings.badge_color }}">
                    {{ section.settings.badge_text }}
                </div>
            {%- endif -%}

            {%- unless discount == '0%' -%}
                <div class="sale ">
                    SALE {{ discount }} OFF
                </div>
            {%- endunless -%}
        </div>

        {%- if has_quick_add -%}
            <modal-opener 
                class="opener"
                data-modal="{{ quick_add_modal }}"
            >
                <button
                    class="quick-view-btn"
                    type="button"
                    aria-haspopup="dialog"
                    data-product-url="{{ product.url }}" 
                >
                    Quick View
                    {%- render 'loading-spinner' -%}
                </button>
            </modal-opener>
        {%- endif -%}
    </responsive-container>

    <div class="product-card__content product-{{ section.settings.alignment }}"
    >
        <div class="product-card__title {{ section.settings.product_title_size }}" 
            style="{% if section.settings.product_title_bold %} font-weight:bold; {% endif %}"
        >
            <a
                href="{{ product.url }}"
                id="StandardCardNoMediaLink-{{ section.id }}-{{ product.id }}"
                class="full-unstyled-link"
                aria-labelledby="StandardCardNoMediaLink-{{ section.id }}-{{ product.id }} NoMediaStandardBadge-{{ section.id }}-{{ product.id }}"
            >
                {{ product.title | escape }}
            </a>
        </div>

        <div class="product-card__price h4">
            {{ current_variant.price | money }}

            {%- if current_variant.compare_at_price > current_variant.price -%}
                <span class="old-price" style="text-decoration: line-through;">
                    {{ current_variant.compare_at_price | money }}
                </span>
            {%- endif -%}
        </div>

        {%- unless product.has_only_default_variant -%}
            {% assign swatch_triggers = section.settings.color_swatch_trigger | split: ',' %}
            {% assign size_triggers = section.settings.size_trigger | split:"," %}

            {% for option in product.options_with_values %}
                {% assign option_name = option.name | strip | downcase %}
                {% assign is_swatch = false %}
                {% assign is_size = false %}

                {% for trigger in swatch_triggers %}
                    {%- assign compare_option = trigger | strip | downcase -%}
                    
                    {%- if option_name == compare_option -%}
                        {%- assign is_swatch = true -%}
                    {%- endif -%}
                {% endfor %}

                {% for trigger in size_triggers %}
                    {%- assign compare_option = trigger | strip | downcase -%}
                    
                    {%- if option_name == compare_option -%}
                        {%- assign is_size = true -%}
                    {%- endif -%}
                {% endfor %}

                {%- if is_swatch -%}
                    <ul class="list-unstyled product-card__swatch">
                        {% for value in option.values limit: 2 %}
                            <li class="swatch">
                                {% assign color_image = value.variant.featured_image | default: product.featured_image %}
                                <a href="{{ product.url }}?variant={{ value.variant.id }}" 
                                    class="color"
                                    style="--swatch-bgc:{{ value.swatch.color }}"
                                    title="{{ value }}"
                                    data-variant-image="{{ color_image | image_url: width: color_image.width }}"
                                    data-variant-image-srcset="{{ color_image | image_url: width: 352 }} 352w, {{ color_image | image_url: width: 832 }} 832w, {{ color_image | image_url: width: 1200 }} 1200w, {{ color_image | image_url: width: 1920 }} 1920w"
                                >
                                </a>
                            </li>
                        {% endfor %}
    
                        {%- if  option.values.size > 2 -%}
                            <li class="swatch">
                                <a href="{{ product.url }}" class="color more"
                                    style="color:rgba(var(--color-foreground));text-decoration:none;"
                                    data-variant-image="{{ product.featured_image | image_url: width:  product.featured_image.width }}"
                                    data-variant-image-srcset="{{ product.featured_image | image_url: width: 352 }} 352w, {{product.featured_image | image_url: width: 832 }} 832w, {{ product.featured_image | image_url: width: 1200 }} 1200w, {{ product.featured_image | image_url: width: 1920 }} 1920w"
                                >
                                    +{{ option.values.size | minus: 2 }}
                                </a>
                            </li>
                        {%- endif -%}        
                    </ul>
                {%- elsif is_size -%}
                    <ul class="list-unstyled product-card__size">
                        {% for value in option.values limit: 2 %}
                            <li class="sizes">
                                {%- assign size_image = value.variant.featured_image | default: product.featured_image -%}
                                <a href="{{ product.url }}?variant={{ value.variant.id }}"
                                    class="size"
                                    title="{{ value.name }}"
                                    style="color:rgba(var(--color-foreground));text-decoration:none;"
                                    data-variant-image="{{ size_image | image_url: width: size_image.width }}"
                                    data-variant-image-srcset="{{ size_image | image_url: width: 352 }} 352w, {{ size_image | image_url: width: 832 }} 832w, {{ size_image | image_url: width: 1200 }} 1200w, {{ size_image | image_url: width: 1920 }} 1920w"
                                >
                                    {{ value.name | escape }}
                                </a>
                            </li>
                        {% endfor %}
    
                        {%- if  option.values.size > 2 -%}
                            <li class="sizes">
                                <a href="{{ product.url }}" class="size more"
                                    style="color:rgba(var(--color-foreground));text-decoration:none;"
                                    data-variant-image="{{ product.featured_image | image_url: width:  product.featured_image.width }}"
                                    data-variant-image-srcset="{{ product.featured_image | image_url: width: 352 }} 352w, {{product.featured_image | image_url: width: 832 }} 832w, {{ product.featured_image | image_url: width: 1200 }} 1200w, {{ product.featured_image | image_url: width: 1920 }} 1920w"
                                >
                                    +{{ option.values.size | minus: 2 }}
                                </a>
                            </li>
                        {%- endif -%}        
                    </ul>
                {%- endif -%}
            {% endfor %}
        {%- endunless -%}
    </div>
</my-product-card>