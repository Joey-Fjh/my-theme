{% schema %}
{
  "name": "my-draggable-carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "section_id",
      "label": "Section ID",
      "info": "Optional custom ID for this section"
    }
  ],
  "blocks": [
    {
      "type": "carousel_card",
      "name": "Carousel Card",
      "settings": [
        {
          "type": "header",
          "content": "Card Content"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Card Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Card Title",
          "default": "Discover Your NewLook"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "default": "Read More"
        },
        {
          "type": "text",
          "id": "date",
          "label": "Date",
          "info": "Leave empty to use current date"
        },
        {
          "type": "header",
          "content": "Badge Settings"
        },
        {
          "type": "checkbox",
          "id": "show_badge",
          "label": "Show Badge",
          "default": false
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Badge Text",
          "default": "NEWS"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "my-draggable-carousel",
      "blocks": [
        {
          "type": "carousel_card",
          "settings": {
            "title": "Discover Your NewLook",
            "show_badge": true,
            "badge_text": "NEWS",
            "link_text": "Read More"
          }
        },
        {
          "type": "carousel_card",
          "settings": {
            "title": "Discover Your NewLook",
            "link_text": "Read More"
          }
        },
        {
          "type": "carousel_card",
          "settings": {
            "title": "Discover Your NewLook",
            "link_text": "Read More"
          }
        },
        {
          "type": "carousel_card",
          "settings": {
            "title": "Discover Your NewLook",
            "link_text": "Read More"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<div class="draggable-carousel-wrapper" id="carousel-{{ section.id }}">
  <div class="draggable-carousel" data-carousel>
    {% for block in section.blocks %}
      <div class="carousel-card" {{ block.shopify_attributes }}>
        <div class="card-image-container">
          {% if block.settings.image %}
            <img width="332" height="332" src="{{ block.settings.image | image_url: width: 332 }}" 
                 alt="{{ block.settings.image.alt | default: block.settings.title }}" 
                 class="card-image"
                 loading="lazy">
          {% else %}
            <div class="card-image-placeholder">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
              </svg>
            </div>
          {% endif %}
          
          {% if block.settings.show_badge and block.settings.badge_text != blank %}
            <div class="news-badge">{{ block.settings.badge_text }}</div>
          {% endif %}
        </div>
        
        <div class="card-content">
          <h3 class="card-title">{{ block.settings.title | default: 'Discover Your NewLook' }}</h3>
          <div class="card-footer">
            {% if block.settings.link_url != blank %}
              <a href="{{ block.settings.link_url }}" class="read-more-link">
                {{ block.settings.link_text | default: 'Read More' }}
              </a>
            {% else %}
              <span class="read-more-link">{{ block.settings.link_text | default: 'Read More' }}</span>
            {% endif %}
            <span class="card-date">{{ block.settings.date | default: 'now' | date: '%d %b' }}</span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{{ 'my-draggable-carousel.css' | asset_url | stylesheet_tag }}

<script defer type="module">
document.addEventListener("DOMContentLoaded", () => {
  // Initialize all carousels on the page
  const carousels = document.querySelectorAll("[data-carousel]")

  carousels.forEach((carousel) => {
    initCarousel(carousel)
  })

  function initCarousel(carousel) {
    let isDragging = false
    let startX = 0
    let scrollLeft = 0

    // Mouse events
    carousel.addEventListener("mousedown", (e) => {
      isDragging = true
      carousel.classList.add("dragging")
      startX = e.pageX - carousel.offsetLeft
      scrollLeft = carousel.scrollLeft
      e.preventDefault()
    })

    carousel.addEventListener("mousemove", (e) => {
      if (!isDragging) return
      e.preventDefault()
      const x = e.pageX - carousel.offsetLeft
      const walk = (x - startX) * 2
      carousel.scrollLeft = scrollLeft - walk
    })

    carousel.addEventListener("mouseup", () => {
      if (isDragging) {
        isDragging = false
        carousel.classList.remove("dragging")
        snapToNearestCard(carousel)
      }
    })

    carousel.addEventListener("mouseleave", () => {
      if (isDragging) {
        isDragging = false
        carousel.classList.remove("dragging")
        snapToNearestCard(carousel)
      }
    })

    // Touch events for mobile
    carousel.addEventListener("touchstart", (e) => {
      isDragging = true
      const touch = e.touches[0]
      startX = touch.pageX - carousel.offsetLeft
      scrollLeft = carousel.scrollLeft
    })

    carousel.addEventListener("touchmove", (e) => {
      if (!isDragging) return
      const touch = e.touches[0]
      const x = touch.pageX - carousel.offsetLeft
      const walk = (x - startX) * 2
      carousel.scrollLeft = scrollLeft - walk
    })

    carousel.addEventListener("touchend", () => {
      isDragging = false
      snapToNearestCard(carousel)
    })

    // Prevent text selection during drag
    carousel.addEventListener("selectstart", () => false)
  }

  // Snap to nearest card function
  function snapToNearestCard(carousel) {
    const cardWidth = 320 + 24 // card width + gap
    const scrollPosition = carousel.scrollLeft
    const nearestCardIndex = Math.round(scrollPosition / cardWidth)
    const targetScrollPosition = nearestCardIndex * cardWidth

    carousel.scrollTo({
      left: targetScrollPosition,
      behavior: "smooth",
    })
  }
})
</script>